name: Update Vulnerability Data

on:
  schedule:
    # Run at 7 AM EST daily (12:00 UTC)
    - cron: '0 12 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  update-vulnerability-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set up Git configuration
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
    
    - name: Run NVD Processing Script
      env:
        # If you need API keys, use GitHub secrets
        VULNCHECK_API_KEY: ${{ secrets.VULNCHECK_API_KEY }}
      run: |
        python code/process_nvd.py
    
    - name: Check for changes
      id: check_changes
      run: |
        git add cvss-te.csv code/last_run.txt data/epss/epss_scores.csv
        if git diff --staged --quiet; then
          echo "No changes to commit"
          echo "changes_exist=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected"
          echo "changes_exist=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Pull Request
      if: steps.check_changes.outputs.changes_exist == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        BRANCH_NAME="vulnerability-data-update-$(date +"%Y%m%d%H%M%S")"
        
        # Create a new branch
        git checkout -b $BRANCH_NAME
        
        # Stage changes
        git add cvss-te.csv code/last_run.txt data/epss/epss_scores.csv
        
        # Commit changes
        git commit -m "Update vulnerability data: $TIMESTAMP"
        
        # Push the branch
        git push origin $BRANCH_NAME
        
        # Create pull request
        gh pr create \
          --base main \
          --head $BRANCH_NAME \
          --title "Update Vulnerability Data: $TIMESTAMP" \
          --body "Automated update of vulnerability data

Includes:
- Updated CVSS-TE CSV
- Updated last run timestamp
- Updated EPSS scores

This is an automated update processed by GitHub Actions."
        
        # Automatically merge the PR
        gh pr merge $BRANCH_NAME --merge