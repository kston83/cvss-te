<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVSS-Threat Enhanced (CVSS-TE) Vulnerability Lookup</title>
    
    <!-- Meta tags for SEO and social sharing -->
    <meta name="description" content="CVSS-TE: A Threat-Enhanced Vulnerability Scoring System combining CVSS Base, Temporal metrics, and real-world threat intelligence for better vulnerability prioritization.">
    <meta name="keywords" content="CVSS, vulnerability scoring, cybersecurity, threat intelligence, CVE lookup">
    <meta property="og:title" content="CVSS-TE Vulnerability Lookup">
    <meta property="og:description" content="Enhanced vulnerability scoring system combining CVSS with threat intelligence">
    <meta property="og:url" content="https://your-domain.com">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    
    <!-- Google Analytics GA4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-27RZTCLPTE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-27RZTCLPTE', { 'anonymize_ip': true });
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <header class="bg-gradient-to-r from-slate-800 to-slate-700 py-8 shadow-md">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-white mb-2 text-center">CVSS-Threat Enhanced (CVSS-TE) Vulnerability Lookup</h1>
            <p class="text-center text-gray-200 mb-1">Threat-Enhanced Vulnerability Scoring System</p>
            <p class="text-center text-gray-300 text-sm" id="last-update-time">Last Updated: Loading...</p>
        </div>
    </header>
    
    <main class="container mx-auto px-4 py-8">
        <!-- Search Panel -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-100">
            <div class="mb-6">
                <label for="cve-input" class="block text-gray-700 font-bold mb-2 text-lg">
                    CVE Lookup
                </label>
                <input 
                    type="text" 
                    id="cve-input" 
                    placeholder="CVE-2021-44228, CVE-2023-23397" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                >
                <p class="text-gray-500 text-sm mt-2">
                    Enter one or more CVE IDs separated by commas
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="severity-filter" class="block text-gray-700 font-medium mb-2">Severity Filter</label>
                    <select id="severity-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        <option value="">All Severities</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="LOW">Low</option>
                    </select>
                </div>

                <div>
                    <label for="sort-by" class="block text-gray-700 font-medium mb-2">Sort Results</label>
                    <select id="sort-by" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        <option value="published_date_desc">Most Recent First</option>
                        <option value="published_date_asc">Oldest First</option>
                        <option value="base_score_desc">Highest Base Score</option>
                        <option value="base_score_asc">Lowest Base Score</option>
                        <option value="cvss-bt_score_desc">Highest CVSS-BT Score</option>
                        <option value="cvss-bt_score_asc">Lowest CVSS-BT Score</option>
                        <option value="cvss-te_score_desc">Highest CVSS-TE Score</option>
                        <option value="epss_desc">Highest EPSS Score</option>
                    </select>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <button 
                    id="search-btn" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex-1"
                >
                    Search Vulnerabilities
                </button>
                <button 
                    id="export-btn" 
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 px-6 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 flex-1"
                >
                    Export Results
                </button>
            </div>
        </section>

        <!-- Quick Help Section -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Tips</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="font-medium text-gray-800 mb-2">Multiple CVEs</h4>
                    <p class="text-sm text-gray-600">Enter multiple CVE IDs separated by commas (e.g., CVE-2021-44228, CVE-2023-23397)</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="font-medium text-gray-800 mb-2">Understanding Scores</h4>
                    <p class="text-sm text-gray-600">Click "What do these scores mean?" to learn about CVSS Base, CVSS-BT, and CVSS-TE scoring</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <h4 class="font-medium text-gray-800 mb-2">Export Results</h4>
                    <p class="text-sm text-gray-600">Download your search results in CSV format for further analysis</p>
                </div>
            </div>
        </section>

        <!-- Stats Panel -->
        <section id="stats-bar" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden border border-gray-100">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="text-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <p class="text-sm text-gray-500 mb-1">Total Results</p>
                    <p id="total-results" class="text-2xl font-bold text-gray-800">0</p>
                </div>
                <div class="text-center p-3 bg-red-50 rounded-lg border border-red-100">
                    <p class="text-sm text-gray-500 mb-1">Critical</p>
                    <p id="critical-count" class="text-2xl font-bold text-red-600">0</p>
                </div>
                <div class="text-center p-3 bg-orange-50 rounded-lg border border-orange-100">
                    <p class="text-sm text-gray-500 mb-1">High</p>
                    <p id="high-count" class="text-2xl font-bold text-orange-600">0</p>
                </div>
                <div class="text-center p-3 bg-orange-50 rounded-lg border border-orange-100">
                    <p class="text-sm text-gray-500 mb-1">High EPSS</p>
                    <p id="high-epss-count" class="text-2xl font-bold text-orange-600">0</p>
                </div>
                <div class="text-center p-3 bg-purple-50 rounded-lg border border-purple-100">
                    <p class="text-sm text-gray-500 mb-1">With Exploits</p>
                    <p id="exploit-count" class="text-2xl font-bold text-purple-600">0</p>
                </div>
            </div>
        </section>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center hidden py-8">
            <div class="spinner"></div>
            <p class="text-gray-600 mt-4">Loading vulnerability data...</p>
        </div>

        <!-- Error Message -->
        <div id="error" class="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-lg mb-8 hidden" role="alert">
            <span class="block sm:inline font-medium" id="error-message"></span>
        </div>

        <!-- Results Section -->
        <!-- Scoring Information Panel -->
        <section id="scoring-info-panel" class="bg-blue-50 rounded-xl shadow-sm p-6 mb-8 border border-blue-100 hidden">
            <div class="flex justify-between items-start mb-2">
                <h3 class="text-lg font-bold text-blue-800">Understanding CVSS Scores</h3>
                <button id="close-info-panel" class="text-blue-600 hover:text-blue-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-2">CVSS Base Score</h4>
                    <p class="text-sm text-gray-600">The standard severity rating based on intrinsic characteristics of a vulnerability, without considering real-world threat context.</p>
                </div>
                <div class="bg-white p-4 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-2">CVSS-BT Score</h4>
                    <p class="text-sm text-gray-600">Base score modified with Temporal metrics, incorporating exploit availability and maturity using the standard CVSS specification.</p>
                </div>
                <div class="bg-white p-4 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-2">CVSS-TE Score</h4>
                    <p class="text-sm text-gray-600">Threat-Enhanced score that extends beyond CVSS-BT by incorporating exploit quality and additional threat intelligence factors for better real-world risk assessment.</p>
                </div>
            </div>
        </section>

        <section id="results-container" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <h2 class="text-xl font-bold text-gray-800 mr-3">Search Results</h2>
                    <button id="show-scoring-info" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-xs font-medium py-1 px-2 rounded-full transition-colors">
                        What do these scores mean?
                    </button>
                </div>
                <span id="results-count" class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">Showing 0 results</span>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="results-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CVE</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="tooltip">
                                        CVSS Base
                                        <span class="tooltiptext">Standard CVSS Base Score - measures intrinsic vulnerability severity without real-world context</span>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="tooltip">
                                        CVSS-BT
                                        <span class="tooltiptext">Base + Temporal Score - adjusts severity based on exploit availability following CVSS standard</span>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="tooltip">
                                        CVSS-TE
                                        <span class="tooltiptext">Threat-Enhanced Score - considers exploit quality, threat intelligence factors, and real-world exploitation for better prioritization</span>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="tooltip">
                                        EPSS
                                        <span class="tooltiptext">Exploit Prediction Scoring System - likelihood of exploitation</span>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Threat Indicators</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Published</th>
                                <th scope="col" class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="bg-white divide-y divide-gray-200">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Modal for CVE details -->
        <div id="cve-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto m-4 shadow-2xl">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800" id="modal-title">CVE Details</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6" id="modal-content">
                    <!-- Modal content will be populated here -->
                </div>
                <div class="p-6 border-t border-gray-200 flex justify-end">
                    <button id="close-modal-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Privacy Notice -->
        <div class="text-center mt-8 mb-4">
            <p class="text-xs text-gray-500">This site uses analytics to improve the tool. No personally identifiable information is collected.</p>
        </div>
    </main>

    <footer class="bg-slate-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div>
                    <h3 class="text-lg font-bold mb-4">About CVSS-TE</h3>
                    <p class="text-gray-400 text-sm">A Threat-Enhanced Vulnerability Scoring System that combines traditional CVSS metrics with real-world threat intelligence.</p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Resources</h3>
                    <ul class="space-y-2">
                        <li>
                            <a href="https://github.com/kston83/cvss-te" class="text-gray-400 hover:text-white transition-colors flex items-center">
                                <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                                GitHub Repository
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/kston83/cvss-te/blob/main/whitepaper.md" class="text-gray-400 hover:text-white transition-colors flex items-center">
                                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                </svg>
                                Read the Whitepaper
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 pt-4 text-center">
                <p class="text-sm text-gray-400">CVSS-TE: Enhancing vulnerability prioritization with threat intelligence context</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const cveInput = document.getElementById('cve-input');
            const searchBtn = document.getElementById('search-btn');
            const exportBtn = document.getElementById('export-btn');
            const severityFilter = document.getElementById('severity-filter');
            const sortBy = document.getElementById('sort-by');
            const loadingIndicator = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const resultsContainer = document.getElementById('results-container');
            const resultsBody = document.getElementById('results-body');
            const resultsCount = document.getElementById('results-count');
            const statsBar = document.getElementById('stats-bar');
            const totalResults = document.getElementById('total-results');
            const criticalCount = document.getElementById('critical-count');
            const highCount = document.getElementById('high-count');
            const exploitCount = document.getElementById('exploit-count');
            const modal = document.getElementById('cve-detail-modal');
            const closeModal = document.getElementById('close-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const lastUpdateTime = document.getElementById('last-update-time');

            let csvData = null;
            let currentResults = [];

            // Analytics tracking functions
            function trackSearch(searchTerm, resultsCount) {
                if (typeof gtag === 'function') {
                    gtag('event', 'search', {
                        'search_term': searchTerm,
                        'results_count': resultsCount
                    });
                }
            }
            
            function trackExport(count) {
                if (typeof gtag === 'function') {
                    gtag('event', 'export', {
                        'items_count': count
                    });
                }
            }
            
            function trackCveView(cveId, severity) {
                if (typeof gtag === 'function') {
                    gtag('event', 'view_cve_details', {
                        'cve_id': cveId,
                        'severity': severity
                    });
                }
            }
            
            function trackFilterChange(filterType, value) {
                if (typeof gtag === 'function') {
                    gtag('event', 'filter_change', {
                        'filter_type': filterType,
                        'filter_value': value
                    });
                }
            }
            
            function trackSortChange(value) {
                if (typeof gtag === 'function') {
                    gtag('event', 'sort_change', {
                        'sort_value': value
                    });
                }
            }

            // Helper function for EPSS display
            function formatEpssPercentage(epssValue) {
                if (epssValue === null || epssValue === undefined) return '0.00%';
                const value = parseFloat(epssValue);
                if (isNaN(value)) return '0.00%';
                return (value * 100).toFixed(2) + '%';
            }

            // Fetch the last run time
            fetch('code/last_run.txt')
                .then(response => response.text())
                .then(text => {
                    const lastRunDate = new Date(text.trim());
                    
                    // Format for UTC display with more explicit options
                    const utcOptions = { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        timeZone: 'UTC' 
                    };
                    const utcTime = lastRunDate.toLocaleString('en-US', utcOptions) + ' UTC';
                    
                    // Format for local display with explicit timezone
                    const localOptions = { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        timeZoneName: 'short'
                    };
                    const localTime = lastRunDate.toLocaleString('en-US', localOptions);
                    
                    lastUpdateTime.textContent = `Last Updated: ${utcTime} / ${localTime}`;
                })
                .catch(error => {
                    console.error('Error fetching last run time:', error);
                    lastUpdateTime.textContent = 'Last Updated: Unknown';
                });

            // Helper Functions
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }

            // Recent searches functionality
            function saveRecentSearch(cveList) {
                const recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
                recentSearches.unshift(cveList);
                if (recentSearches.length > 5) recentSearches.pop();
                localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
                displayRecentSearches();
            }

            function displayRecentSearches() {
                const recentSearches = JSON.parse(localStorage.getItem('recentSearches') || '[]');
                if (recentSearches.length === 0) return;

                const recentSearchesHtml = `
                    <div class="mt-4">
                        <p class="text-sm text-gray-600">Recent Searches:</p>
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${recentSearches.map(search => `
                                <button class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded-full transition-colors">
                                    ${search}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;

                // Add after the search input
                const searchInput = document.querySelector('#cve-input');
                const existingRecentSearches = document.querySelector('.recent-searches');
                if (existingRecentSearches) {
                    existingRecentSearches.remove();
                }
                const recentSearchesDiv = document.createElement('div');
                recentSearchesDiv.className = 'recent-searches';
                recentSearchesDiv.innerHTML = recentSearchesHtml;
                searchInput.insertAdjacentElement('afterend', recentSearchesDiv);

                // Add click handlers to recent search buttons
                recentSearchesDiv.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => {
                        cveInput.value = button.textContent.trim();
                        searchBtn.click();
                    });
                });
            }

            function getSeverityColor(score) {
                if (!score) return 'bg-gray-400 text-white';
                const numScore = parseFloat(score);
                if (numScore >= 9.0) return 'bg-red-600 text-white';
                if (numScore >= 7.0) return 'bg-orange-600 text-white';
                if (numScore >= 4.0) return 'bg-yellow-500 text-black';
                return 'bg-green-600 text-white';
            }
            
            // Function for progress bar coloring
            function getEpssColor(epssScore) {
                if (!epssScore && epssScore !== 0) return 'epss-unknown';
                const score = parseFloat(epssScore);
                if (score >= 0.5) return 'epss-critical'; // Critical (50%+)
                if (score >= 0.36) return 'epss-high';    // High (36%+) - EPSS threshold from README
                if (score >= 0.1) return 'epss-medium';   // Medium (10-36%)
                return 'epss-low';                        // Low (<10%)
            }
            
            // Function for text coloring (separate from progress bar)
            function getEpssTextColor(epssScore) {
                if (!epssScore && epssScore !== 0) return 'epss-text-unknown';
                const score = parseFloat(epssScore);
                if (score >= 0.5) return 'epss-text-critical';   // Critical
                if (score >= 0.36) return 'epss-text-high';      // High
                if (score >= 0.1) return 'epss-text-medium';     // Medium
                return 'epss-text-low';                          // Low
            }

            function hasExploits(cve) {
                // Check if any of these are truthy (1 instead of true)
                return cve.exploitdb || cve.metasploit || cve.nuclei || cve.poc_github;
            }

            function createThreatIndicatorBadges(cve) {
                const indicators = [
                    { key: 'cisa_kev', label: 'CISA KEV', color: 'bg-red-500' },
                    { key: 'vulncheck_kev', label: 'VulnCheck KEV', color: 'bg-orange-500' },
                    { key: 'exploitdb', label: 'Exploit DB', color: 'bg-yellow-500' },
                    { key: 'metasploit', label: 'Metasploit', color: 'bg-green-600' },
                    { key: 'nuclei', label: 'Nuclei', color: 'bg-blue-600' },
                    { key: 'poc_github', label: 'GitHub PoC', color: 'bg-purple-600' }
                ];

                const badges = indicators
                    // Filter based on truthy values (1) rather than strictly === true
                    .filter(indicator => cve[indicator.key])
                    .map(indicator => 
                        `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${indicator.color} text-white mr-1 mb-1">
                            ${indicator.label}
                        </span>`
                    )
                    .join('');
                
                return badges || '<span class="text-gray-500 text-sm italic">No Active Indicators</span>';
            }

            function showCVEDetails(cve) {
                modalTitle.textContent = `${cve.cve} Details`;
                
                const content = `
                    <!-- Single-column header for basic info -->
                    <div class="mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h4 class="font-bold mb-3 text-lg text-gray-800">Vulnerability Details</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Published:</p>
                                    <p class="font-medium">${formatDate(cve.published_date)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Last Modified:</p>
                                    <p class="font-medium">${formatDate(cve.last_modified_date)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Assigner:</p>
                                    <p class="font-medium">${cve.assigner || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CVSS Scores row - 3 score boxes side by side -->
                    <div class="mb-6">
                        <h4 class="font-bold mb-3 text-lg text-gray-800">Scoring</h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <p class="font-medium text-gray-700 mb-2">CVSS Base</p>
                                <span class="inline-flex items-center px-3 py-1 rounded-lg ${getSeverityColor(cve.base_score)}">
                                    ${cve.base_score || 'N/A'} (${cve.base_severity || 'N/A'})
                                </span>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <p class="font-medium text-gray-700 mb-2">CVSS-BT (Temporal)</p>
                                <span class="inline-flex items-center px-3 py-1 rounded-lg ${getSeverityColor(cve['cvss-bt_score'])}">
                                    ${cve['cvss-bt_score'] || 'N/A'} (${cve['cvss-bt_severity'] || 'N/A'})
                                </span>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <p class="font-medium text-gray-700 mb-2">CVSS-TE (Enhanced)</p>
                                <span class="inline-flex items-center px-3 py-1 rounded-lg ${getSeverityColor(cve['cvss-te_score'])}">
                                    ${cve['cvss-te_score'] || 'N/A'} (${cve['cvss-te_severity'] || 'N/A'})
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- EPSS Score -->
                    <div class="mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h4 class="font-medium text-gray-700 mb-2">EPSS Score</h4>
                            <div class="flex items-center mb-2">
                                <div class="epss-progress-container mr-2 flex-grow">
                                    <div class="epss-progress-bar ${getEpssColor(cve.epss)}" style="width: ${Math.min(cve.epss * 100, 100)}%"></div>
                                </div>
                                <span class="text-sm ${getEpssTextColor(cve.epss)} ml-2 w-16 text-right">${formatEpssPercentage(cve.epss)}</span>
                            </div>
                            <p class="text-xs text-gray-500">Exploit Prediction Scoring System - likelihood of exploitation</p>
                        </div>
                    </div>

                    <!-- Two-column layout for vectors and threat intel -->
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-bold mb-3 text-lg text-gray-800">CVSS Vectors</h4>
                            <div class="mb-3">
                                <p class="text-sm text-gray-600 mb-1">Base Vector:</p>
                                <p class="bg-gray-50 p-2 rounded-lg text-sm font-mono border border-gray-200">${cve.base_vector || "N/A"}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 mb-1">CVSS-BT Vector:</p>
                                <p class="bg-gray-50 p-2 rounded-lg text-sm font-mono border border-gray-200">${cve['cvss-bt_vector'] || "N/A"}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold mb-3 text-lg text-gray-800">Threat Intelligence</h4>
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
                                <p class="font-medium text-gray-700 mb-2">Indicators:</p>
                                <div>${createThreatIndicatorBadges(cve)}</div>
                            </div>
                            
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <h4 class="font-medium text-gray-700 mb-2">Exploit Quality</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <p><span class="font-medium">Quality Score:</span> ${(cve.quality_score * 100).toFixed(1)}%</p>
                                    <p><span class="font-medium">Exploit Sources:</span> ${cve.exploit_sources}</p>
                                    <p><span class="font-medium">Reliability:</span> ${(cve.reliability * 100).toFixed(0)}%</p>
                                    <p><span class="font-medium">Ease of Use:</span> ${(cve.ease_of_use * 100).toFixed(0)}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- References -->
                    <div class="mt-6">
                        <h4 class="font-bold mb-3 text-lg text-gray-800">References</h4>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <a href="https://nvd.nist.gov/vuln/detail/${cve.cve}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline block mb-2">
                                NIST NVD Database: ${cve.cve}
                            </a>
                            <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cve.cve}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline block">
                                Mitre CVE: ${cve.cve}
                            </a>
                        </div>
                    </div>
                `;
                
                modalContent.innerHTML = content;
                modal.classList.remove('hidden');
                
                // Track modal view in analytics
                trackCveView(cve.cve, cve['cvss-te_severity']);
                
                // Prevent background scrolling
                document.body.style.overflow = 'hidden';
            }

            function closeDetailModal() {
                modal.classList.add('hidden');
                // Restore background scrolling
                document.body.style.overflow = '';
            }

            function displayCVEResults(results) {
                resultsBody.innerHTML = '';
                currentResults = results;
                
                // Update results count
                resultsCount.textContent = `Showing ${results.length} result${results.length !== 1 ? 's' : ''}`;
                
                // Update stats
                totalResults.textContent = results.length;
                criticalCount.textContent = results.filter(cve => cve['cvss-te_severity'] === 'CRITICAL').length;
                highCount.textContent = results.filter(cve => cve['cvss-te_severity'] === 'HIGH').length;
                document.getElementById('high-epss-count').textContent = results.filter(cve => cve.epss && cve.epss >= 0.36).length;
                exploitCount.textContent = results.filter(cve => hasExploits(cve)).length;
                
                // Show the stats bar
                statsBar.classList.remove('hidden');

                results.forEach(cve => {
                    const threatIndicatorBadges = createThreatIndicatorBadges(cve);
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cve.cve}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-1 rounded-lg text-sm font-medium ${getSeverityColor(cve.base_score)}">
                                ${cve.base_score || 'N/A'} (${cve.base_severity || 'N/A'})
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-1 rounded-lg text-sm font-medium ${getSeverityColor(cve['cvss-bt_score'])}">
                                ${cve['cvss-bt_score'] || 'N/A'} (${cve['cvss-bt_severity'] || 'N/A'})
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-1 rounded-lg text-sm font-medium ${getSeverityColor(cve['cvss-te_score'])}">
                                ${cve['cvss-te_score'] || 'N/A'} (${cve['cvss-te_severity'] || 'N/A'})
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="epss-table-container mr-2 flex-grow">
                                    <div class="epss-progress-bar ${getEpssColor(cve.epss)}" style="width: ${Math.min(cve.epss * 100, 100)}%"></div>
                                </div>
                                <span class="text-xs ${getEpssTextColor(cve.epss)}">${formatEpssPercentage(cve.epss)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            ${threatIndicatorBadges}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatDate(cve.published_date)}</td>
                        <td class="px-6 py-4 text-center">
                            <button class="view-details bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium py-1 px-3 rounded-lg transition-colors">
                                Details
                            </button>
                        </td>
                    `;
                    
                    const viewButton = row.querySelector('.view-details');
                    viewButton.addEventListener('click', () => showCVEDetails(cve));
                    
                    resultsBody.appendChild(row);
                });

                resultsContainer.classList.remove('hidden');
            }

            function filterAndSortResults(results) {
                const severityFilterValue = severityFilter.value;
                const sortByValue = sortBy.value;

                let filteredResults = [...results];

                // Apply severity filter
                if (severityFilterValue) {
                    filteredResults = filteredResults.filter(cve => 
                        cve['cvss-te_severity'] === severityFilterValue
                    );
                }

                // Apply sorting
                switch(sortByValue) {
                    case 'published_date_desc':
                        filteredResults.sort((a, b) => new Date(b.published_date || 0) - new Date(a.published_date || 0));
                        break;
                    case 'published_date_asc':
                        filteredResults.sort((a, b) => new Date(a.published_date || 0) - new Date(b.published_date || 0));
                        break;
                    case 'base_score_desc':
                        filteredResults.sort((a, b) => (parseFloat(b.base_score) || 0) - (parseFloat(a.base_score) || 0));
                        break;
                    case 'base_score_asc':
                        filteredResults.sort((a, b) => (parseFloat(a.base_score) || 0) - (parseFloat(b.base_score) || 0));
                        break;
                    case 'cvss-bt_score_desc':
                        filteredResults.sort((a, b) => (parseFloat(b['cvss-bt_score']) || 0) - (parseFloat(a['cvss-bt_score']) || 0));
                        break;
                    case 'cvss-bt_score_asc':
                        filteredResults.sort((a, b) => (parseFloat(a['cvss-bt_score']) || 0) - (parseFloat(b['cvss-bt_score']) || 0));
                        break;
                    case 'cvss-te_score_desc':
                        filteredResults.sort((a, b) => (parseFloat(b['cvss-te_score']) || 0) - (parseFloat(a['cvss-te_score']) || 0));
                        break;
                    case 'epss_desc':
                        filteredResults.sort((a, b) => (parseFloat(b.epss) || 0) - (parseFloat(a.epss) || 0));
                        break;
                }

                return filteredResults;
            }

            // Load data immediately
            loadingIndicator.classList.remove('hidden');
            
            // Fetch the CSV file (from the root directory for GitHub Pages)
            fetch('cvss-te.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    // Parse CSV
                    const parseResult = Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });
                    
                    if (parseResult.errors && parseResult.errors.length > 0) {
                        console.warn('CSV parsing warnings:', parseResult.errors);
                    }
                    
                    csvData = parseResult.data;

                    // Fix any potential data issues
                    csvData = csvData.filter(row => row && row.cve && row.cve.startsWith('CVE-'));
                    
                    // Track data loaded event
                    if (typeof gtag === 'function') {
                        gtag('event', 'data_loaded', {
                            'cve_count': csvData.length
                        });
                    }
                    
                    // Hide loading indicator
                    loadingIndicator.classList.add('hidden');
                    console.log(`Loaded ${csvData.length} CVE records successfully`);
                })
                .catch(error => {
                    console.error('Error loading CSV:', error);
                    loadingIndicator.classList.add('hidden');
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'Error loading CVE data: ' + error.message;
                });

            // Event Listeners
            // Search button event listener
            searchBtn.addEventListener('click', function() {
                // Reset previous results and errors
                errorDiv.classList.add('hidden');
                resultsContainer.classList.add('hidden');
                
                // Get and process CVE input
                const inputText = cveInput.value.trim();
                
                if (!inputText) {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'Please enter valid CVE(s)';
                    return;
                }
                
                const inputCVEs = inputText.split(',')
                    .map(cve => {
                        cve = cve.trim().toUpperCase();
                        // Add CVE- prefix if missing
                        if (cve.match(/^\d{4}-\d+$/)) {
                            return 'CVE-' + cve;
                        }
                        return cve;
                    })
                    .filter(cve => cve.match(/^CVE-\d{4}-\d+$/));

                if (inputCVEs.length === 0) {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'Please enter valid CVE(s)';
                    return;
                }

                // If CSV is not loaded
                if (!csvData || csvData.length === 0) {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'CVE data not loaded. Please reload the page and try again.';
                    return;
                }

                // Find matching CVEs
                const matchedCVEs = [];
                
                inputCVEs.forEach(cve => {
                    const match = csvData.find(row => row && row.cve === cve);
                    if (match) {
                        matchedCVEs.push(match);
                    }
                });

                // Handle no matches
                if (matchedCVEs.length === 0) {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'No matching CVEs found';
                    return;
                }

                // Apply current filters and sorting
                const filteredAndSorted = filterAndSortResults(matchedCVEs);
                
                // Track search analytics
                trackSearch(inputText, matchedCVEs.length);
                
                // Save recent search
                saveRecentSearch(inputText);
                
                // Display matched CVEs
                displayCVEResults(filteredAndSorted);
            });

            // Export button event listener
            exportBtn.addEventListener('click', function() {
                if (currentResults.length === 0) {
                    alert('No results to export');
                    return;
                }

                // Create CSV content
                const headers = ['CVE', 'Base Score', 'Base Severity', 'CVSS-BT Score', 'CVSS-BT Severity', 'CVSS-TE Score', 'CVSS-TE Severity', 'EPSS Score', 'CVSS-BT Vector', 'Published Date'];
                const csvContent = [
                    headers.join(','),
                    ...currentResults.map(cve => 
                        [
                            cve.cve, 
                            cve.base_score, 
                            cve.base_severity,
                            cve['cvss-bt_score'],
                            cve['cvss-bt_severity'],
                            cve['cvss-te_score'], 
                            cve['cvss-te_severity'],
                            cve.epss ? (cve.epss * 100).toFixed(2) + '%' : '0%',
                            `"${(cve['cvss-bt_vector'] || '').replace(/"/g, '""')}"`,
                            cve.published_date
                        ].join(',')
                    )
                ].join('\n');

                // Track export analytics
                trackExport(currentResults.length);

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'cvss-te-results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // Filter and sort event listeners
            severityFilter.addEventListener('change', function() {
                trackFilterChange('severity', this.value);
                
                if (currentResults.length > 0) {
                    const filtered = filterAndSortResults(currentResults);
                    displayCVEResults(filtered);
                }
            });

            sortBy.addEventListener('change', function() {
                trackSortChange(this.value);
                
                if (currentResults.length > 0) {
                    const filtered = filterAndSortResults(currentResults);
                    displayCVEResults(filtered);
                }
            });

            // Modal close button events
            closeModal.addEventListener('click', closeDetailModal);
            closeModalBtn.addEventListener('click', closeDetailModal);
            
            // Close modal when clicking outside content
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeDetailModal();
                }
            });
            
            // Close modal on escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeDetailModal();
                }
            });

            // Keyboard shortcut for search (Enter in the search box)
            cveInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    searchBtn.click();
                }
            });

            // Scoring info panel controls
            const scoringInfoPanel = document.getElementById('scoring-info-panel');
            const showScoringInfoBtn = document.getElementById('show-scoring-info');
            const closeInfoPanelBtn = document.getElementById('close-info-panel');

            showScoringInfoBtn.addEventListener('click', function() {
                scoringInfoPanel.classList.remove('hidden');
                // Track info panel view
                if (typeof gtag === 'function') {
                    gtag('event', 'view_info_panel');
                }
                // Smooth scroll to the panel
                scoringInfoPanel.scrollIntoView({ behavior: 'smooth' });
            });

            closeInfoPanelBtn.addEventListener('click', function() {
                scoringInfoPanel.classList.add('hidden');
            });

            // Remove the automatic display on first search
            let firstSearchDone = false;
            searchBtn.addEventListener('click', function() {
                if (!firstSearchDone && currentResults.length > 0) {
                    firstSearchDone = true;
                }
            });
        });
    </script>
</body>
</html>