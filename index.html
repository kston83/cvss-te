<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVSS-TE Vulnerability Lookup</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="./styles.css">
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <header class="bg-gradient-to-r from-slate-800 to-slate-700 py-8 shadow-md">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-white mb-2 text-center">CVSS-TE Vulnerability Lookup</h1>
            <p class="text-center text-gray-200 mb-1">Threat-Enhanced Vulnerability Scoring System</p>
            <p class="text-center text-gray-300 text-sm" id="last-update-time">Last Updated: Loading...</p>
        </div>
    </header>
    
    <main class="container mx-auto px-4 py-8">
        <!-- Search Panel -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-100">
            <div class="mb-6">
                <label for="cve-input" class="block text-gray-700 font-bold mb-2 text-lg">
                    CVE Lookup
                </label>
                <input 
                    type="text" 
                    id="cve-input" 
                    placeholder="CVE-2021-44228, CVE-2023-23397" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                >
                <p class="text-gray-500 text-sm mt-2">
                    Enter one or more CVE IDs separated by commas
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label for="severity-filter" class="block text-gray-700 font-medium mb-2">Severity Filter</label>
                    <select id="severity-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        <option value="">All Severities</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="LOW">Low</option>
                    </select>
                </div>

                <div>
                    <label for="sort-by" class="block text-gray-700 font-medium mb-2">Sort Results</label>
                    <select id="sort-by" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        <option value="published_date_desc">Most Recent First</option>
                        <option value="published_date_asc">Oldest First</option>
                        <option value="base_score_desc">Highest Base Score</option>
                        <option value="base_score_asc">Lowest Base Score</option>
                        <option value="cvss-bt_score_desc">Highest CVSS-BT Score</option>
                        <option value="cvss-bt_score_asc">Lowest CVSS-BT Score</option>
                        <option value="cvss-te_score_desc">Highest CVSS-TE Score</option>
                    </select>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <button 
                    id="search-btn" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex-1"
                >
                    Search Vulnerabilities
                </button>
                <button 
                    id="export-btn" 
                    class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 px-6 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 flex-1"
                >
                    Export Results
                </button>
            </div>
        </section>

        <!-- Stats Panel -->
        <section id="stats-bar" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden border border-gray-100">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="text-center p-4 bg-gray-50 rounded-lg border border-gray-100">
                    <p class="text-sm text-gray-500 mb-1">Total Results</p>
                    <p id="total-results" class="text-2xl font-bold text-gray-800">0</p>
                </div>
                <div class="text-center p-4 bg-red-50 rounded-lg border border-red-100">
                    <p class="text-sm text-gray-500 mb-1">Critical</p>
                    <p id="critical-count" class="text-2xl font-bold text-red-600">0</p>
                </div>
                <div class="text-center p-4 bg-orange-50 rounded-lg border border-orange-100">
                    <p class="text-sm text-gray-500 mb-1">High</p>
                    <p id="high-count" class="text-2xl font-bold text-orange-600">0</p>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg border border-purple-100">
                    <p class="text-sm text-gray-500 mb-1">With Exploits</p>
                    <p id="exploit-count" class="text-2xl font-bold text-purple-600">0</p>
                </div>
            </div>
        </section>

        <!-- Loading Indicator -->
        <div id="loading" class="text-center hidden py-8">
            <div class="spinner"></div>
            <p class="text-gray-600 mt-4">Loading vulnerability data...</p>
        </div>

        <!-- Error Message -->
        <div id="error" class="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-lg mb-8 hidden" role="alert">
            <span class="block sm:inline font-medium" id="error-message"></span>
        </div>

        <!-- Results Section -->
        <section id="results-container" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Search Results</h2>
                <span id="results-count" class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">Showing 0 results</span>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="results-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CVE</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="tooltip">
                                        CVSS Base
                                        <span class="tooltiptext">Standard CVSS Base Score</span>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="tooltip">
                                        CVSS-BT
                                        <span class="tooltiptext">Standards-compliant CVSS Base+Temporal Score</span>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <div class="tooltip">
                                        CVSS-TE
                                        <span class="tooltiptext">Threat-Enhanced Score with intelligence context</span>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Threat Indicators</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Published</th>
                                <th scope="col" class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="results-body" class="bg-white divide-y divide-gray-200">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Modal for CVE details -->
        <div id="cve-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto m-4 shadow-2xl">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800" id="modal-title">CVE Details</h3>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6" id="modal-content">
                    <!-- Modal content will be populated here -->
                </div>
                <div class="p-6 border-t border-gray-200 flex justify-end">
                    <button id="close-modal-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-slate-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-2">CVSS-TE: Threat-Enhanced Vulnerability Scoring System</p>
            <p class="text-sm text-gray-400">Enhancing vulnerability prioritization with threat intelligence context</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const cveInput = document.getElementById('cve-input');
            const searchBtn = document.getElementById('search-btn');
            const exportBtn = document.getElementById('export-btn');
            const severityFilter = document.getElementById('severity-filter');
            const sortBy = document.getElementById('sort-by');
            const loadingIndicator = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const resultsContainer = document.getElementById('results-container');
            const resultsBody = document.getElementById('results-body');
            const resultsCount = document.getElementById('results-count');
            const statsBar = document.getElementById('stats-bar');
            const totalResults = document.getElementById('total-results');
            const criticalCount = document.getElementById('critical-count');
            const highCount = document.getElementById('high-count');
            const exploitCount = document.getElementById('exploit-count');
            const modal = document.getElementById('cve-detail-modal');
            const closeModal = document.getElementById('close-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const lastUpdateTime = document.getElementById('last-update-time');

            let csvData = null;
            let currentResults = [];

            // Fetch the last run time
            fetch('code/last_run.txt')
                .then(response => response.text())
                .then(text => {
                    const lastRunDate = new Date(text.trim());
                    lastUpdateTime.textContent = `Last Updated: ${lastRunDate.toLocaleString()}`;
                })
                .catch(error => {
                    console.error('Error fetching last run time:', error);
                    lastUpdateTime.textContent = 'Last Updated: Unknown';
                });

            // Helper Functions
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }

            function getSeverityColor(score) {
                if (!score) return 'bg-gray-400 text-white';
                const numScore = parseFloat(score);
                if (numScore >= 9.0) return 'bg-red-600 text-white';
                if (numScore >= 7.0) return 'bg-orange-600 text-white';
                if (numScore >= 4.0) return 'bg-yellow-500 text-black';
                return 'bg-green-600 text-white';
            }

            function hasExploits(cve) {
                // Check if any of these are truthy (1 instead of true)
                return cve.exploitdb || cve.metasploit || cve.nuclei || cve.poc_github;
            }

            function createThreatIndicatorBadges(cve) {
                const indicators = [
                    { key: 'cisa_kev', label: 'CISA KEV', color: 'bg-red-500' },
                    { key: 'vulncheck_kev', label: 'VulnCheck KEV', color: 'bg-orange-500' },
                    { key: 'exploitdb', label: 'Exploit DB', color: 'bg-yellow-500' },
                    { key: 'metasploit', label: 'Metasploit', color: 'bg-green-600' },
                    { key: 'nuclei', label: 'Nuclei', color: 'bg-blue-600' },
                    { key: 'poc_github', label: 'GitHub PoC', color: 'bg-purple-600' }
                ];

                const badges = indicators
                    // Filter based on truthy values (1) rather than strictly === true
                    .filter(indicator => cve[indicator.key])
                    .map(indicator => 
                        `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${indicator.color} text-white mr-1 mb-1">
                            ${indicator.label}
                        </span>`
                    )
                    .join('');
                
                return badges || '<span class="text-gray-500 text-sm italic">No Active Indicators</span>';
            }

            function showCVEDetails(cve) {
                modalTitle.textContent = `${cve.cve} Details`;
                
                let cveDescription = cve.description || "No description available";
                
                const content = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="font-bold mb-3 text-lg text-gray-800">Vulnerability Details</h4>
                            <div class="mb-4 space-y-2">
                                <p><span class="font-medium text-gray-700">Published:</span> ${formatDate(cve.published_date)}</p>
                                <p><span class="font-medium text-gray-700">Last Modified:</span> ${formatDate(cve.last_modified_date)}</p>
                            </div>
                            <p class="mb-3 font-medium text-gray-700">Description:</p>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm text-gray-800">
                                ${cveDescription}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold mb-3 text-lg text-gray-800">Scoring</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <p class="font-medium text-gray-700 mb-2">CVSS Base</p>
                                    <span class="inline-flex items-center px-3 py-1 rounded-lg ${getSeverityColor(cve.base_score)}">
                                        ${cve.base_score || 'N/A'} (${cve.base_severity || 'N/A'})
                                    </span>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                    <p class="font-medium text-gray-700 mb-2">CVSS-BT (Temporal)</p>
                                    <span class="inline-flex items-center px-3 py-1 rounded-lg ${getSeverityColor(cve['cvss-bt_score'])}">
                                        ${cve['cvss-bt_score'] || 'N/A'} (${cve['cvss-bt_severity'] || 'N/A'})
                                    </span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
                                <p class="font-medium text-gray-700 mb-2">CVSS-TE (Enhanced)</p>
                                <span class="inline-flex items-center px-3 py-1 rounded-lg ${getSeverityColor(cve['cvss-te_score'])}">
                                    ${cve['cvss-te_score'] || 'N/A'} (${cve['cvss-te_severity'] || 'N/A'})
                                </span>
                            </div>
                            
                            <h4 class="font-bold mt-6 mb-2 text-gray-800">CVSS Vectors</h4>
                            <div class="mb-3">
                                <p class="text-sm text-gray-600 mb-1">Base Vector:</p>
                                <p class="bg-gray-50 p-2 rounded-lg text-sm font-mono border border-gray-200">${cve.base_vector || "N/A"}</p>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-1">CVSS-BT Vector:</p>
                                <p class="bg-gray-50 p-2 rounded-lg text-sm font-mono border border-gray-200">${cve['cvss-bt_vector'] || "N/A"}</p>
                            </div>
                            
                            <h4 class="font-bold mt-6 mb-2 text-gray-800">Threat Intelligence</h4>
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
                                <p class="font-medium text-gray-700 mb-2">Indicators:</p>
                                <div>${createThreatIndicatorBadges(cve)}</div>
                            </div>
                            
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <h4 class="font-medium text-gray-700 mb-2">Exploit Quality</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <p><span class="font-medium">Quality Score:</span> ${(cve.quality_score * 100).toFixed(1)}%</p>
                                    <p><span class="font-medium">Exploit Sources:</span> ${cve.exploit_sources}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="font-bold mb-3 text-lg text-gray-800">References</h4>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <a href="https://nvd.nist.gov/vuln/detail/${cve.cve}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline block mb-2">
                                NIST NVD Database: ${cve.cve}
                            </a>
                            <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cve.cve}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline block">
                                Mitre CVE: ${cve.cve}
                            </a>
                        </div>
                    </div>
                `;
                
                modalContent.innerHTML = content;
                modal.classList.remove('hidden');
                
                // Prevent background scrolling
                document.body.style.overflow = 'hidden';
            }

            function closeDetailModal() {
                modal.classList.add('hidden');
                // Restore background scrolling
                document.body.style.overflow = '';
            }

            function displayCVEResults(results) {
                resultsBody.innerHTML = '';
                currentResults = results;
                
                // Update results count
                resultsCount.textContent = `Showing ${results.length} result${results.length !== 1 ? 's' : ''}`;
                
                // Update stats
                totalResults.textContent = results.length;
                criticalCount.textContent = results.filter(cve => cve['cvss-te_severity'] === 'CRITICAL').length;
                highCount.textContent = results.filter(cve => cve['cvss-te_severity'] === 'HIGH').length;
                exploitCount.textContent = results.filter(cve => hasExploits(cve)).length;
                
                // Show the stats bar
                statsBar.classList.remove('hidden');

                results.forEach(cve => {
                    const threatIndicatorBadges = createThreatIndicatorBadges(cve);
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cve.cve}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-1 rounded-lg text-sm font-medium ${getSeverityColor(cve.base_score)}">
                                ${cve.base_score || 'N/A'} (${cve.base_severity || 'N/A'})
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-1 rounded-lg text-sm font-medium ${getSeverityColor(cve['cvss-bt_score'])}">
                                ${cve['cvss-bt_score'] || 'N/A'} (${cve['cvss-bt_severity'] || 'N/A'})
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-1 rounded-lg text-sm font-medium ${getSeverityColor(cve['cvss-te_score'])}">
                                ${cve['cvss-te_score'] || 'N/A'} (${cve['cvss-te_severity'] || 'N/A'})
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            ${threatIndicatorBadges}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${formatDate(cve.published_date)}</td>
                        <td class="px-6 py-4 text-center">
                            <button class="view-details bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium py-1 px-3 rounded-lg transition-colors">
                                Details
                            </button>
                        </td>
                    `;
                    
                    const viewButton = row.querySelector('.view-details');
                    viewButton.addEventListener('click', () => showCVEDetails(cve));
                    
                    resultsBody.appendChild(row);
                });

                resultsContainer.classList.remove('hidden');
            }

            function filterAndSortResults(results) {
                const severityFilterValue = severityFilter.value;
                const sortByValue = sortBy.value;

                let filteredResults = [...results];

                // Apply severity filter
                if (severityFilterValue) {
                    filteredResults = filteredResults.filter(cve => 
                        cve['cvss-te_severity'] === severityFilterValue
                    );
                }

                // Apply sorting
                switch(sortByValue) {
                    case 'published_date_desc':
                        filteredResults.sort((a, b) => new Date(b.published_date || 0) - new Date(a.published_date || 0));
                        break;
                    case 'published_date_asc':
                        filteredResults.sort((a, b) => new Date(a.published_date || 0) - new Date(b.published_date || 0));
                        break;
                    case 'base_score_desc':
                        filteredResults.sort((a, b) => (parseFloat(b.base_score) || 0) - (parseFloat(a.base_score) || 0));
                        break;
                    case 'base_score_asc':
                        filteredResults.sort((a, b) => (parseFloat(a.base_score) || 0) - (parseFloat(b.base_score) || 0));
                        break;
                    case 'cvss-bt_score_desc':
                        filteredResults.sort((a, b) => (parseFloat(b['cvss-bt_score']) || 0) - (parseFloat(a['cvss-bt_score']) || 0));
                        break;
                    case 'cvss-bt_score_asc':
                        filteredResults.sort((a, b) => (parseFloat(a['cvss-bt_score']) || 0) - (parseFloat(b['cvss-bt_score']) || 0));
                        break;
                    case 'cvss-te_score_desc':
                        filteredResults.sort((a, b) => (parseFloat(b['cvss-te_score']) || 0) - (parseFloat(a['cvss-te_score']) || 0));
                        break;
                }

                return filteredResults;
            }

            // Load data immediately
            loadingIndicator.classList.remove('hidden');
            
            // Fetch the CSV file (from the root directory for GitHub Pages)
            fetch('cvss-te.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    // Parse CSV
                    const parseResult = Papa.parse(csvText, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });
                    
                    if (parseResult.errors && parseResult.errors.length > 0) {
                        console.warn('CSV parsing warnings:', parseResult.errors);
                    }
                    
                    csvData = parseResult.data;

                    // Fix any potential data issues
                    csvData = csvData.filter(row => row && row.cve && row.cve.startsWith('CVE-'));
                    
                    // Hide loading indicator
                    loadingIndicator.classList.add('hidden');
                    console.log(`Loaded ${csvData.length} CVE records successfully`);
                })
                .catch(error => {
                    console.error('Error loading CSV:', error);
                    loadingIndicator.classList.add('hidden');
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'Error loading CVE data: ' + error.message;
                });

            // Event Listeners
            // Search button event listener
            searchBtn.addEventListener('click', function() {
                // Reset previous results and errors
                errorDiv.classList.add('hidden');
                resultsContainer.classList.add('hidden');
                
                // Get and process CVE input
                const inputText = cveInput.value.trim();
                
                if (!inputText) {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'Please enter valid CVE(s)';
                    return;
                }
                
                const inputCVEs = inputText.split(',')
                    .map(cve => {
                        cve = cve.trim().toUpperCase();
                        // Add CVE- prefix if missing
                        if (cve.match(/^\d{4}-\d+$/)) {
                            return 'CVE-' + cve;
                        }
                        return cve;
                    })
                    .filter(cve => cve.match(/^CVE-\d{4}-\d+$/));

                if (inputCVEs.length === 0) {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'Please enter valid CVE(s)';
                    return;
                }

                // If CSV is not loaded
                if (!csvData || csvData.length === 0) {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'CVE data not loaded. Please reload the page and try again.';
                    return;
                }

                // Find matching CVEs
                const matchedCVEs = [];
                
                inputCVEs.forEach(cve => {
                    const match = csvData.find(row => row && row.cve === cve);
                    if (match) {
                        matchedCVEs.push(match);
                    }
                });

                // Handle no matches
                if (matchedCVEs.length === 0) {
                    errorDiv.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'No matching CVEs found';
                    return;
                }

                // Apply current filters and sorting
                const filteredAndSorted = filterAndSortResults(matchedCVEs);
                
                // Display matched CVEs
                displayCVEResults(filteredAndSorted);
            });

            // Export button event listener
            exportBtn.addEventListener('click', function() {
                if (currentResults.length === 0) {
                    alert('No results to export');
                    return;
                }

                // Create CSV content
                const headers = ['CVE', 'Base Score', 'Base Severity', 'CVSS-BT Score', 'CVSS-BT Severity', 'CVSS-TE Score', 'CVSS-TE Severity', 'CVSS-BT Vector', 'Published Date', 'Description'];
                const csvContent = [
                    headers.join(','),
                    ...currentResults.map(cve => 
                        [
                            cve.cve, 
                            cve.base_score, 
                            cve.base_severity,
                            cve['cvss-bt_score'],
                            cve['cvss-bt_severity'],
                            cve['cvss-te_score'], 
                            cve['cvss-te_severity'],
                            `"${(cve['cvss-bt_vector'] || '').replace(/"/g, '""')}"`,
                            cve.published_date,
                            `"${(cve.description || '').replace(/"/g, '""')}"`
                        ].join(',')
                    )
                ].join('\n');

                // Create and trigger download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'cvss-te-results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // Filter and sort event listeners
            severityFilter.addEventListener('change', function() {
                if (currentResults.length > 0) {
                    const filtered = filterAndSortResults(currentResults);
                    displayCVEResults(filtered);
                }
            });

            sortBy.addEventListener('change', function() {
                if (currentResults.length > 0) {
                    const filtered = filterAndSortResults(currentResults);
                    displayCVEResults(filtered);
                }
            });

            // Modal close button events
            closeModal.addEventListener('click', closeDetailModal);
            closeModalBtn.addEventListener('click', closeDetailModal);
            
            // Close modal when clicking outside content
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeDetailModal();
                }
            });
            
            // Close modal on escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeDetailModal();
                }
            });

            // Keyboard shortcut for search (Enter in the search box)
            cveInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    searchBtn.click();
                }
            });
        });
    </script>
</body>
</html>